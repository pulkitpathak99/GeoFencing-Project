<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Control and Geofencing</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .geofence-controls, .terminal-controls {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #geofenceStatus, #terminalStatus {
            margin-top: 20px;
            font-weight: bold;
        }
        #terminalList {
            margin-top: 20px;
        }
        .terminal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .terminal-item:last-child {
            border-bottom: none;
        }
        .loading {
            display: none;
            margin-left: 10px;
        }
        #message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        #searchTerminal {
            margin-bottom: 10px;
            padding: 5px;
            width: 100%;
        }

        header nav ul li .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--primary-color);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            min-width: 200px;
            border-radius: 4px;
            overflow: hidden;
        }

        header nav ul li .dropdown-content a {
            display: block;
            padding: 0.5rem 1rem;
        }

        header nav ul li .dropdown-content a:hover {
            background-color: var(--secondary-color);
        }

        header nav ul li:hover .dropdown-content {
            display: block;
        }

    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="#"><img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo"></a>
            </div>
            <nav>
                <ul>
                    <li><a href="{{ url_for('home') }}">Home</a></li>
                    <li><a href="{{ url_for('get_latest_data') }}">Current Location</a></li>
                    <li><a href="{{ url_for('map_page') }}">Map View</a></li>
                    <li><a href="/path">Track Path</a></li>
                    <li><a href="/terminal">Terminal History</a></li>
                    <li><a class="active" href="/control">Control Terminals</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main>
        <h1>Terminal Control and Geofencing</h1>
        <div class="geofence-controls">
            <h2>Geofence Selection</h2>
            <select id="stateSelector">
                <option value="">Select State</option>
            </select>
            <select id="districtSelector" disabled>
                <option value="">Select District</option>
            </select>
            <button id="setGeofenceBtn">Set Geofence</button>
            <button id="removeGeofenceBtn" disabled>Remove Geofence</button>
            <span id="geofenceLoading" class="loading">Loading...</span>
        </div>
        
        <div id="message"></div>
        
        <div id="geofenceStatus"></div>
        
        <div class="terminal-controls">
            <h2>Terminals in Selected Area</h2>
            <input type="text" id="searchTerminal" placeholder="Search terminals...">
            <div id="terminalList"></div>
            <div id="terminalLoading" class="loading">Loading terminals...</div>
        </div>
    </main>

    <footer>
        <!-- Add footer content here -->
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();
            const stateSelector = document.getElementById('stateSelector');
            const districtSelector = document.getElementById('districtSelector');
            const setGeofenceBtn = document.getElementById('setGeofenceBtn');
            const removeGeofenceBtn = document.getElementById('removeGeofenceBtn');
            const geofenceLoading = document.getElementById('geofenceLoading');
            const messageDiv = document.getElementById('message');
            const geofenceStatus = document.getElementById('geofenceStatus');
            const terminalList = document.getElementById('terminalList');
            const terminalLoading = document.getElementById('terminalLoading');
            const searchTerminal = document.getElementById('searchTerminal');

            function showMessage(type, text) {
                messageDiv.className = type;
                messageDiv.textContent = text;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            function loadStates() {
                fetch('/api/states')
                    .then(response => response.json())
                    .then(states => {
                        states.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state;
                            option.textContent = state;
                            stateSelector.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading states:', error));
            }

            function loadDistricts(state) {
                districtSelector.innerHTML = '<option value="">Select District</option>';
                districtSelector.disabled = !state;
                if (!state) return;

                fetch(`/api/districts?state=${state}`)
                    .then(response => response.json())
                    .then(districts => {
                        districts.forEach(district => {
                            const option = document.createElement('option');
                            option.value = district;
                            option.textContent = district;
                            districtSelector.appendChild(option);
                        });
                        districtSelector.disabled = false;
                    })
                    .catch(error => console.error('Error loading districts:', error));
            }

            function updateGeofenceStatus() {
    fetch('/api/active_geofence')
        .then(response => response.json())
        .then(data => {
            if (data.active) {
                geofenceStatus.textContent = `Active Geofence: ${data.state}, ${data.district}`;
                removeGeofenceBtn.disabled = false;
            } else {
                geofenceStatus.textContent = 'No active geofence';
                removeGeofenceBtn.disabled = true;
            }
        })
        .catch(error => console.error('Error fetching active geofence:', error));
}

function updateTerminalStatus(deviceId, status) {
    const terminalItem = terminalList.querySelector(`[data-device-id="${deviceId}"]`);
    if (terminalItem) {
        const statusSpan = terminalItem.querySelector('.terminal-status');
        statusSpan.textContent = status;
        statusSpan.className = `terminal-status ${status.toLowerCase()}`;
    }
}

// Modify the loadTerminals function
function loadTerminals() {
    const state = stateSelector.value;
    const district = districtSelector.value;
    terminalLoading.style.display = 'inline';
    terminalList.innerHTML = '';

    fetch(`/api/terminals-by-location?state=${state}&district=${district}`)
        .then(response => response.json())
        .then(terminals => {
            terminals.forEach(terminal => {
                const terminalItem = document.createElement('div');
                terminalItem.className = 'terminal-item';
                terminalItem.innerHTML = `
                    <span>${terminal.device_id}</span>
                    <span class="terminal-status ${terminal.status.toLowerCase()}">${terminal.status}</span>
                    <button class="toggle-terminal" data-device-id="${terminal.device_id}">
                        Toggle Transmission
                    </button>
                `;
                terminalList.appendChild(terminalItem);
            });
            terminalLoading.style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading terminals:', error);
            terminalLoading.style.display = 'none';
            showMessage('error', 'Failed to load terminals');
        });
}

// Modify the toggleTerminal function
function toggleTerminal(deviceId) {
    const button = terminalList.querySelector(`[data-device-id="${deviceId}"]`);
    button.disabled = true;
    fetch('/api/toggle_terminal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ device_id: deviceId }),
    })
        .then(response => response.json())
        .then(data => {
            showMessage('success', data.message);
            updateTerminalStatus(deviceId, data.status);
        })
        .catch(error => {
            console.error('Error toggling terminal:', error);
            showMessage('error', 'Failed to toggle terminal');
        })
        .finally(() => {
            button.disabled = false;
        });
}

            function setGeofence() {
                const state = stateSelector.value;
                const district = districtSelector.value;
                if (!state || !district) {
                    showMessage('error', 'Please select both state and district');
                    return;
                }

                geofenceLoading.style.display = 'inline';
                fetch('/api/set_geofence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state, district }),
                })
                    .then(response => response.json())
                    .then(data => {
                        showMessage('success', data.message);
                        geofenceStatus.textContent = `Active Geofence: ${state}, ${district}`;
                        removeGeofenceBtn.disabled = false;
                        loadTerminals();
                    })
                    .catch(error => {
                        console.error('Error setting geofence:', error);
                        showMessage('error', 'Failed to set geofence');
                    })
                    .finally(() => {
                        geofenceLoading.style.display = 'none';
                    });
            }

            function removeGeofence() {
                const state = stateSelector.value;
                const district = districtSelector.value;
                if (!state || !district) {
                    showMessage('error', 'Please select both state and district');
                    return;
                }

                geofenceLoading.style.display = 'inline';
                fetch('/api/remove_geofence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state, district }),
                })
                    .then(response => response.json())
                    .then(data => {
                        showMessage('success', data.message);
                        geofenceStatus.textContent = '';
                        removeGeofenceBtn.disabled = true;
                        loadTerminals();
                    })
                    .catch(error => {
                        console.error('Error removing geofence:', error);
                        showMessage('error', 'Failed to remove geofence');
                    })
                    .finally(() => {
                        geofenceLoading.style.display = 'none';
                    });
            }

            function toggleTerminal(deviceId) {
                fetch('/api/toggle_terminal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ device_id: deviceId }),
                })
                    .then(response => response.json())
                    .then(data => {
                        showMessage('success', data.message);
                    })
                    .catch(error => {
                        console.error('Error toggling terminal:', error);
                        showMessage('error', 'Failed to toggle terminal');
                    });
            }

            stateSelector.addEventListener('change', () => {
                loadDistricts(stateSelector.value);
                loadTerminals();
            });

            districtSelector.addEventListener('change', loadTerminals);

            setGeofenceBtn.addEventListener('click', setGeofence);
            removeGeofenceBtn.addEventListener('click', removeGeofence);

            terminalList.addEventListener('click', (event) => {
                if (event.target.classList.contains('toggle-terminal')) {
                    const deviceId = event.target.dataset.deviceId;
                    toggleTerminal(deviceId);
                }
            });

            searchTerminal.addEventListener('input', () => {
                const searchTerm = searchTerminal.value.toLowerCase();
                const terminalItems = terminalList.querySelectorAll('.terminal-item');
                terminalItems.forEach(item => {
                    const deviceId = item.querySelector('span').textContent.toLowerCase();
                    item.style.display = deviceId.includes(searchTerm) ? 'flex' : 'none';
                });
            });

            socket.on('geofence_update', (data) => {
                showMessage('success', `Terminal ${data.device_id} ${data.action}ed geofence ${data.geofence}`);
                loadTerminals();
            });

            loadStates();
            updateGeofenceStatus();
    setInterval(updateGeofenceStatus, 30000); // Update every 30 seconds

    socket.on('terminal_status_update', (data) => {
        updateTerminalStatus(data.device_id, data.status);
    });
        });
    </script>
</body>
</html>