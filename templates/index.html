<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Terminal Locations</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <header class="bg-blue-900 text-white">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="logo">
                <a href="#"><img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="h-12"></a>
            </div>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="{{ url_for('home') }}" class="hover:underline">Home</a></li>
                    <li><a href="{{ url_for('get_latest_data') }}" class="font-bold underline">Current Location</a></li>
                    <li><a id="mapLink" href="{{ url_for('map_page') }}" class="hover:underline">Map View</a></li>
                    <li><a href="/path" class="hover:underline">Track Path</a></li>
                    <li><a href="/terminal" class="hover:underline">Terminal History</a></li>
                    <li><a href="/control" class="hover:underline">Control Terminals</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-blue-900 mb-8">Current Terminal Locations</h1>
        
        <div class="mb-6 flex justify-end">
            <button id="exportButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                Export as CSV
            </button>
        </div>

        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table id="data-table" class="min-w-full">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">SAI</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Device ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Latitude</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Longitude</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">District</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">State</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </main>

    <footer class="bg-blue-900 text-white py-4">
        <div class="container mx-auto px-4">
            <ul class="flex justify-center space-x-6">
                <li><a href="#" class="hover:underline">About</a></li>
                <li><a href="#" class="hover:underline">Terms</a></li>
                <li><a href="#" class="hover:underline">Privacy Policy</a></li>
                <li><a href="#" class="hover:underline">Contact Us</a></li>
            </ul>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.querySelector('#data-table tbody');
            const exportButton = document.getElementById('exportButton');
            let allData = [];

            function fetchLatestData() {
                fetch('/api/latest-terminal-data')
                    .then(response => response.json())
                    .then(data => {
                        allData = data;
                        updateTable();
                    });
            }

            function updateTable() {
                tableBody.innerHTML = '';
                allData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(row.timestamp).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.sai}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.device_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.latitude}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.longitude}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.district}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.state}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            // Fetch data initially and set up periodic updates
            fetchLatestData();
            setInterval(fetchLatestData, 10000); // Update every 10 seconds

            var socket = io();

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });

            socket.on('geofence_update', function(data) {
                console.log('Geofence update:', data);
                fetchLatestData(); // Refresh data when a geofence update is received
            });

            exportButton.addEventListener('click', function () {
                let csv = 'Timestamp,SAI,Device ID,Latitude,Longitude,District,State,Status\n';
                allData.forEach(row => {
                    csv += `${new Date(row.timestamp).toLocaleString()},${row.sai},${row.device_id},${row.latitude},${row.longitude},${row.district},${row.state},${row.status || 'N/A'}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, 'current_terminal_locations.csv');
                } else {
                    link.href = URL.createObjectURL(blob);
                    link.download = 'current_terminal_locations.csv';
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
        });
    </script>
</body>
</html>