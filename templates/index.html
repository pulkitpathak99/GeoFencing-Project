<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Terminal Locations</title>
</head>
<style>
    :root {
        --primary-color: #003366;
        --secondary-color: #64b5f6;
        --accent-color: #f57c00;
        --background-color: #f4f6f8;
        --text-color: #333;
        --white: #ffffff;
        --success-color: #4CAF50;
        --warning-color: #FFC107;
        --error-color: #F44336;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--background-color);
        color: var(--text-color);
    }

    header {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: var(--white);
        padding: 1rem 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    header .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
    }

    header .logo img {
        height: 60px;
        transition: transform 0.3s ease;
    }

    header .logo img:hover {
        transform: scale(1.05);
    }

    header nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
    }

    header nav ul li {
        margin-left: 1.5rem;
    }

    header nav ul li a {
        color: var(--white);
        text-decoration: none;
        font-size: 1rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    header nav ul li a:hover,
    header nav ul li a.active {
        background-color: rgb(242, 47, 47);
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }


    header nav ul li .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--primary-color);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            min-width: 200px;
            border-radius: 4px;
            overflow: hidden;
        }

        header nav ul li .dropdown-content a {
            display: block;
            padding: 0.5rem 1rem;
        }

        header nav ul li .dropdown-content a:hover {
            background-color: var(--secondary-color);
        }

        header nav ul li:hover .dropdown-content {
            display: block;
        }


    main {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background-color: var(--white);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }

    h1 {
        color: var(--primary-color);
        text-align: center;
        padding-bottom: 20px;
    }

    .actions-container {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
    }

    #exportButton {
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #exportButton:hover {
        background-color: #002244;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }

    th {
        background-color: var(--primary-color);
        color: var(--white);
    }

    tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    tbody tr:hover {
        background-color: #f0f0f0;
    }

    footer {
        background-color: var(--primary-color);
        color: var(--white);
        padding: 10px 0;
        text-align: center;
    }

    footer ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    footer ul li a {
        color: var(--white);
        text-decoration: none;
    }

    footer ul li a:hover {
        text-decoration: underline;
    }
</style>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="#"><img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo"></a>
            </div>
            <nav>
                <ul>
                    <li><a href="{{ url_for('home') }}">Home</a></li>
                    <li><a href="{{ url_for('get_latest_data') }}" class="active">Current Location</a></li>
                    <li><a href="{{ url_for('map_page') }}">Map View</a></li>
                    <li><a href="/path">Track Path</a></li>
                    <li><a href="/terminal" >Terminal History</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropbtn">Control Terminals</a>
                        <div class="dropdown-content">
                            <a href="/control">Control Terminals</a>
                            <a href="/geofence-control">Geofence Control</a>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <h1>Current Terminal Locations</h1>
        
        <div class="btn-container">
            <button id="exportButton" class="btn btn-secondary">
                Export as CSV
            </button>
        </div>

        <div class="card">
            <table id="data-table" class="data-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>SAI</th>
                        <th>Device ID</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>District</th>
                        <th>State</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <div class="container">
            <ul>
                <li><a href="#">About</a></li>
                <li><a href="#">Terms</a></li>
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">Contact Us</a></li>
            </ul>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.querySelector('#data-table tbody');
            const exportButton = document.getElementById('exportButton');
            let allData = [];

            function fetchLatestData() {
                fetch('/api/latest-terminal-data')
                    .then(response => response.json())
                    .then(data => {
                        allData = data;
                        updateTable();
                    });
            }

            function updateTable() {
                tableBody.innerHTML = '';
                allData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(row.timestamp).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.sai}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.device_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.latitude}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.longitude}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.district}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${row.state}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            // Fetch data initially and set up periodic updates
            fetchLatestData();
            setInterval(fetchLatestData, 10000); // Update every 10 seconds

            var socket = io();

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });

            socket.on('geofence_update', function(data) {
                console.log('Geofence update:', data);
                fetchLatestData(); // Refresh data when a geofence update is received
            });

            exportButton.addEventListener('click', function () {
                let csv = 'Timestamp,SAI,Device ID,Latitude,Longitude,District,State,Status\n';
                allData.forEach(row => {
                    csv += `${new Date(row.timestamp).toLocaleString()},${row.sai},${row.device_id},${row.latitude},${row.longitude},${row.district},${row.state},${row.status || 'N/A'}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, 'current_terminal_locations.csv');
                } else {
                    link.href = URL.createObjectURL(blob);
                    link.download = 'current_terminal_locations.csv';
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
        });
    </script>
</body>
</html>