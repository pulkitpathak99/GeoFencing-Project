<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Path Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
</head>
<style>

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f8;
      color: #333;
    }

    header {
  background: linear-gradient(135deg, var(--primary-color), #0056b3);
  color: var(--white);
  padding: 1rem 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

header .container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem;
}

header .logo img {
  height: 60px;
  transition: transform 0.3s ease;
}

header .logo img:hover {
  transform: scale(1.05);
}

header nav ul {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
}

header nav ul li {
  margin-left: 1.5rem;
}

header nav ul li a {
  color: var(--white);
  text-decoration: none;
  font-size: 1rem;
  font-weight: 500;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  transition: all 0.3s ease;
}

header nav ul li a:hover,
header nav ul li a.active {
  background-color: rgba(255, 255, 255, 0.1);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

    :root {
  --primary-color: #003366;
  --secondary-color: #64b5f6;
  --accent-color: #f57c00;
  --background-color: #f4f6f8;
  --text-color: #333;
  --white: #ffffff;
  --success-color: #4CAF50;
  --warning-color: #FFC107;
  --error-color: #F44336;
}

    main {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1 {
      color: #003366;
      text-align: center;
      padding-bottom: 20px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding-bottom: 20px;
    }

    form label {
      flex: 1 0 100px;
    }

    form select, form button {
      flex: 1 0 calc(33% - 10px);
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    form input[type="checkbox"] {
      margin-right: 5px;
    }

    form button {
      background-color: #003366;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }

    form button:hover {
      background-color: #002244;
    }
    header nav ul li .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--primary-color);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            min-width: 200px;
            border-radius: 4px;
            overflow: hidden;
        }

        header nav ul li .dropdown-content a {
            display: block;
            padding: 0.5rem 1rem;
        }

        header nav ul li .dropdown-content a:hover {
            background-color: var(--secondary-color);
        }

        header nav ul li:hover .dropdown-content {
            display: block;
        }


    #map {
      height: 600px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #loading-indicator {
      display: none;
      text-align: center;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 5px;
      z-index: 9999;
      font-size: 18px;
    }

    .leaflet-popup-content {
      font-size: 14px;
    }
    .leaflet-popup-content p {
      margin: 5px 0;
    }

    @media (max-width: 768px) {
      header .container {
        flex-direction: column;
        align-items: flex-start;
      }

      form {
        flex-direction: column;
        gap: 10px;
      }

      footer ul {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
<body>
  <header>
    <div class="container">
        <div class="logo">
            <a href="#"><img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo"></a>
        </div>
        <nav>
            <ul>
                <li><a href="{{ url_for('home') }}">Home</a></li>
                <li><a href="{{ url_for('get_latest_data') }}">Current Location</a></li>
                <li><a href="{{ url_for('map_page') }}">Map View</a></li>
                <li><a href="/path" class="active">Track Path</a></li>
                <li><a href="/terminal" >Terminal History</a></li>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Control Terminals</a>
                    <div class="dropdown-content">
                        <a href="/control">Control Terminals</a>
                        <a href="/geofence-control">Geofence Control</a>
                    </div>
                </li>
            </ul>
        </nav>
    </div>
</header>

    <main>
        <h1>Terminal Path Viewer</h1>
        <div class="card">
            <form id="terminal-form">
                <label for="terminal">Select Terminal:</label>
                <select id="terminal" name="terminal" required>
                    <option value="" selected disabled>Select terminal</option>
                </select>

                <label for="timeframe">Select Timeframe:</label>
                <select id="timeframe" name="timeframe" required>
                    <option value="1">Last Hour</option>
                    <option value="6">Last 6 Hours</option>
                    <option value="12">Last 12 Hours</option>
                    <option value="24">Last 24 Hours</option>
                    <option value="48">Last 48 Hours</option>
                    <option value="168">Last Week</option>
                </select>

                <button type="submit" class="btn">Show Path</button>
            </form>

            <div id="map"></div>

            <div id="loading-indicator" class="loading-indicator">Loading...</div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const map = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://api.maptiler.com/maps/basic-v2/{z}/{x}/{y}.png?key=wP321pEI0NlgtSZjA8kP', {
                attribution: '&copy; <a href="https://www.maptiler.com/copyright">MapTiler</a> contributors'
            }).addTo(map);

            const loadingIndicator = document.getElementById('loading-indicator');
            const terminalSelect = document.getElementById('terminal');
            const markers = L.markerClusterGroup();

            const startIcon = L.icon({
                iconUrl: '/static/images/start-icon.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            const endIcon = L.icon({
                iconUrl: '/static/images/end-icon.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            const wayPointIcon = L.icon({
                iconUrl: '/static/images/waypoint-icon.png',
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                popupAnchor: [0, -8]
            });

            fetch('/api/terminals')
                .then(response => response.json())
                .then(data => {
                    data.forEach(terminal => {
                        const option = document.createElement('option');
                        option.value = terminal.id;
                        option.textContent = terminal.name;
                        terminalSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching terminals:', error);
                    alert('Failed to load terminals.');
                });

            document.getElementById('terminal-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const terminalId = terminalSelect.value;
                const timeframe = document.getElementById('timeframe').value;
                if (!terminalId || !timeframe) {
                    alert('Please select a terminal and a timeframe.');
                    return;
                }

                loadingIndicator.style.display = 'block';
                fetch(`/api/path?terminal=${terminalId}&timeframe=${timeframe}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingIndicator.style.display = 'none';
                        markers.clearLayers();

                        if (!data || data.length === 0) {
                            alert('No path data available for the selected terminal and timeframe.');
                            return;
                        }

                        const coordinates = data.map(point => [point.latitude, point.longitude]);
                        const startPoint = coordinates[0];
                        const endPoint = coordinates[coordinates.length - 1];

                        L.marker(startPoint, { icon: startIcon })
                            .addTo(map)
                            .bindPopup(`<b>Start</b><br>${data[0].timestamp}`);
                        
                        L.marker(endPoint, { icon: endIcon })
                            .addTo(map)
                            .bindPopup(`<b>End</b><br>${data[data.length-1].timestamp}`);

                        data.forEach((point, index) => {
                            if (index !== 0 && index !== data.length - 1) {
                                const marker = L.marker([point.latitude, point.longitude], { icon: wayPointIcon })
                                    .bindPopup(`<b>Waypoint</b><br>${point.timestamp}`);
                                markers.addLayer(marker);
                            }
                        });

                        map.addLayer(markers);

                        const pathLine = L.polyline(coordinates, { 
                            color: 'blue',
                            weight: 3,
                            opacity: 0.7,
                            dashArray: '10, 10',
                            lineCap: 'round'
                        }).addTo(map);

                        map.fitBounds(pathLine.getBounds());
                    })
                    .catch(error => {
                        loadingIndicator.style.display = 'none';
                        console.error('Error fetching path data:', error);
                        alert('Failed to load path data.');
                    });
            });
        });
    </script>
</body>
</html>